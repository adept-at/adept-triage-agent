name: Release

# Trigger on GitHub Release creation (not tag push)
on:
  release:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to release (e.g., v1.7.1)'
        required: true

jobs:
  verify-and-prepare:
    runs-on: ubuntu-latest
    outputs:
      needs-commit: ${{ steps.check.outputs.needs-commit }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build and verify dist
        id: check
        run: |
          echo "üî® Building dist files..."
          npm run build
          npm run package

          # Check if dist files are properly bundled
          DIST_SIZE=$(stat -f%z dist/index.js 2>/dev/null || stat -c%s dist/index.js)
          echo "üì¶ dist/index.js size: $DIST_SIZE bytes"

          if [ "$DIST_SIZE" -lt 1000000 ]; then
            echo "‚ùå ERROR: dist/index.js is too small ($DIST_SIZE bytes). Not properly bundled!"
            exit 1
          fi

          # Check for external requires
          if grep -q "require.*@actions/core" dist/index.js; then
            echo "‚ùå ERROR: Found external requires in dist/index.js. Not properly bundled!"
            exit 1
          fi

          # Check if dist needs to be committed
          if [ -n "$(git diff dist/)" ]; then
            echo "üìù dist/ files have changed and need to be committed"
            echo "needs-commit=true" >> $GITHUB_OUTPUT
            
            # Commit the changes
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add dist/
            git commit -m "chore: update dist files for release

            Auto-generated by release workflow to ensure bundled dist files
            are included in the release tag."
            git push origin main
            
            echo "‚úÖ Committed updated dist files to main"
          else
            echo "‚úÖ dist/ files are up to date"
            echo "needs-commit=false" >> $GITHUB_OUTPUT
          fi

  publish-release:
    runs-on: ubuntu-latest
    needs: verify-and-prepare

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main # Always use main with updated dist

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Final build for release
        run: |
          npm run build
          npm run package

          # Final verification
          DIST_SIZE=$(stat -f%z dist/index.js 2>/dev/null || stat -c%s dist/index.js)
          echo "üì¶ Final dist/index.js size: $DIST_SIZE bytes"

          if [ "$DIST_SIZE" -lt 1000000 ]; then
            echo "‚ùå CRITICAL: dist/index.js is not properly bundled!"
            exit 1
          fi

      # Create or move tag to latest main commit (with updated dist)
      - name: Update release tag
        if: github.event_name == 'release'
        env:
          TAG: ${{ github.event.release.tag_name }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Delete old tag if it exists
          git push origin :refs/tags/$TAG || true

          # Create new tag at current HEAD (with updated dist)
          git tag -a $TAG -m "Release $TAG"
          git push origin $TAG

          echo "‚úÖ Updated tag $TAG to latest main with bundled dist"

      # Upload the built artifact to the existing release
      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: ./dist/index.js
          asset_name: index.js
          asset_content_type: application/javascript

      # For workflow_dispatch, create the release
      - name: Create Release (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.tag }}
          release_name: Release ${{ github.event.inputs.tag }}
          body: |
            ## Changes in this Release

            See commit history for detailed changes.

            ### Installation
            ```yaml
            - uses: adept-at/adept-triage-agent@${{ github.event.inputs.tag }}
              with:
                GITHUB_TOKEN: ${{ '${{ secrets.GITHUB_TOKEN }}' }}
                OPENAI_API_KEY: ${{ '${{ secrets.OPENAI_API_KEY }}' }}
            ```

            See [README](https://github.com/${{ github.repository }}/blob/main/README.md) for detailed usage instructions.
          draft: false
          prerelease: false

      - name: Upload Release Asset (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./dist/index.js
          asset_name: index.js
          asset_content_type: application/javascript

  update-major-tag:
    runs-on: ubuntu-latest
    needs: publish-release
    if: github.event.release.tag_name || github.event.inputs.tag

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main # Use main with updated dist
          fetch-depth: 0

      - name: Update major version tag
        env:
          TAG: ${{ github.event.release.tag_name || github.event.inputs.tag }}
        run: |
          # Extract version from tag
          VERSION=${TAG#v}
          MAJOR_VERSION=$(echo $VERSION | cut -d. -f1)

          git config user.name github-actions
          git config user.email github-actions@github.com

          # Force update the major version tag
          git tag -fa "v$MAJOR_VERSION" -m "Update major version tag to v$VERSION"
          git push origin "v$MAJOR_VERSION" --force

          echo "‚úÖ Updated v$MAJOR_VERSION tag to point to v$VERSION"
