name: Cypress Tests with Auto-Triage

on:
  repository_dispatch:
    types: [trigger-skill-preview-sauce]

jobs:
  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - name: Generate matrix
        id: set-matrix
        run: |
          DIRECTORY="cypress/skills-preview-url"
          FILES=$(ls -1 "$DIRECTORY" | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix=$FILES" >> $GITHUB_OUTPUT

  previewUrlTest:
    needs: generate-matrix
    runs-on: ubuntu-latest
    timeout-minutes: 7
    strategy:
      fail-fast: false
      matrix:
        containers: ${{ fromJson(needs.generate-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run Cypress
        id: cypress
        run: >
          npx cypress run --spec ./cypress/skills-preview-url/${{ matrix.containers }}
          -C cypress.skillbuilder-vercel.sauce.config.ts
          -c baseUrl=${{ github.event.client_payload.target_url }}
          -b chrome
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SAUCE_ACCESS_KEY: ${{ secrets.SAUCE_ACCESS_KEY }}
          SAUCE_USERNAME: ${{ secrets.SAUCE_USERNAME }}
      
      # THIS IS THE ONLY ADDITION NEEDED - Just add this step!
      - name: Triage Test Failures
        if: failure()
        id: triage
        uses: ./  # For published action, use: adept-at/adept-triage-agent@v1
        with:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      
      - uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cy-logs-${{ matrix.containers }}-${{ github.run_id }}
          path: |
            cypress/logs/*
            cypress/videos/*
            cypress/screenshots/*
          if-no-files-found: ignore
          
      - name: Notify on failure
        if: failure()
        uses: adept-at/adept-common/.github/actions/triage-slack-notify@main
        with:
          slack-webhook-url: ${{ secrets.CYPRESS_SLACK_WEBHOOK_URL }}
          verdict: ${{ steps.triage.outputs.verdict }}
          confidence: ${{ steps.triage.outputs.confidence }}
          summary: ${{ steps.triage.outputs.summary }}
          job-name: '${{ github.job }} (${{ matrix.containers }})'
          workflow-run-id: ${{ github.run_id }}
          repository: ${{ github.event.client_payload.repo }}
          spec: ${{ matrix.containers }}
          branch: ${{ github.event.client_payload.branch }}
          commit-sha: ${{ github.event.client_payload.sha }}
          pr-number: ${{ github.event.client_payload.pr_number }}
          preview-url: ${{ github.event.client_payload.target_url }}
          has-fix-recommendation: ${{ steps.triage.outputs.has_fix_recommendation }}
          fix-confidence: ${{ steps.triage.outputs.fix_confidence }}
          fix-summary: ${{ steps.triage.outputs.fix_summary }}